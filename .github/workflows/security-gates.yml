name: üîê DevSecOps Security Gates

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]
  workflow_dispatch: # Manual trigger

# Least privilege permissions
permissions:
  contents: read
  security-events: write # For SARIF uploads
  pull-requests: write # For PR comments
  actions: read

env:
  NODE_VERSION: '20'
  DOTNET_VERSION: '8.0.x'
  REPORTS_DIR: 'reports'

# Cancel in-progress runs for the same workflow
concurrency:
  group: security-gates-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Job 1: Setup and Preparation
  # ==========================================================================
  setup:
    name: üìã Setup & Validation
    runs-on: ubuntu-latest
    outputs:
      should_scan: ${{ steps.check.outputs.should_scan }}
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0 # Full history for better analysis

      - name: Check if scan is needed
        id: check
        run: |
          echo "should_scan=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Security scan will proceed"

      - name: Create reports directory
        run: mkdir -p ${{ env.REPORTS_DIR }}

      - name: Upload reports directory
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: reports-setup
          path: ${{ env.REPORTS_DIR }}
          retention-days: 7

  # ==========================================================================
  # Job 2: Secret Scanning
  # ==========================================================================
  secrets-scan:
    name: üîç Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_scan == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@cb7149b9f3e57f78450d60b8f53bdd475e79770c # v2.3.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Generate Gitleaks report
        if: always()
        run: |
          mkdir -p ${{ env.REPORTS_DIR }}
          if [ -f gitleaks-report.json ]; then
            cp gitleaks-report.json ${{ env.REPORTS_DIR }}/
            echo "‚úÖ Gitleaks report generated"
          else
            echo "[]" > ${{ env.REPORTS_DIR }}/gitleaks-report.json
            echo "‚ÑπÔ∏è  No secrets detected"
          fi

      - name: Upload secret scan results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: secret-scan-results
          path: ${{ env.REPORTS_DIR }}/gitleaks-report.json
          retention-days: 30

  # ==========================================================================
  # Job 3: SAST Scanning (CodeQL)
  # ==========================================================================
  sast-scan:
    name: üõ°Ô∏è SAST Scanning (CodeQL)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_scan == 'true'
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'csharp' ]
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Initialize CodeQL
        uses: github/codeql-action/init@c36620d31ac7c881962c3d9dd939c40ec9434f2b # v3.26.12
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: Setup .NET (for C# analysis)
        if: matrix.language == 'csharp'
        uses: actions/setup-dotnet@6bd8b7f7774af54e05809fcc5431931b3eb1ddee # v4.0.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build .NET project
        if: matrix.language == 'csharp'
        run: |
          cd apps/dotnet-api
          dotnet restore
          dotnet build --no-restore --configuration Release

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@c36620d31ac7c881962c3d9dd939c40ec9434f2b # v3.26.12
        with:
          category: "/language:${{ matrix.language }}"
          output: ${{ env.REPORTS_DIR }}
          upload: true

  # ==========================================================================
  # Job 4: Dependency Scanning
  # ==========================================================================
  dependency-scan:
    name: üì¶ Dependency Scanning
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_scan == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@0a44ba7841725637a19e28fa30b79a866c81b0a6 # v4.0.4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/node-api/package-lock.json

      - name: Setup .NET
        uses: actions/setup-dotnet@6bd8b7f7774af54e05809fcc5431931b3eb1ddee # v4.0.1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Node.js dependencies
        working-directory: apps/node-api
        run: npm ci

      - name: Run npm audit
        working-directory: apps/node-api
        run: |
          mkdir -p ../../${{ env.REPORTS_DIR }}
          npm audit --json > ../../${{ env.REPORTS_DIR }}/npm-audit.json || true
          echo "‚úÖ npm audit completed"

      - name: Restore .NET dependencies
        working-directory: apps/dotnet-api
        run: dotnet restore

      - name: Check .NET vulnerabilities
        working-directory: apps/dotnet-api
        run: |
          mkdir -p ../../${{ env.REPORTS_DIR }}
          dotnet list package --vulnerable --include-transitive --format json > ../../${{ env.REPORTS_DIR }}/dotnet-vulnerable.json || true
          echo "‚úÖ .NET vulnerability check completed"

      - name: Upload dependency scan results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: dependency-scan-results
          path: ${{ env.REPORTS_DIR }}/*.json
          retention-days: 30

  # ==========================================================================
  # Job 5: IaC Scanning (Checkov)
  # ==========================================================================
  iac-scan:
    name: üèóÔ∏è IaC Scanning (Checkov)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_scan == 'true'
    permissions:
      security-events: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@a56af27003a59e0335c786698e89e1398c9c0ff5 # v12.2867.0
        with:
          directory: infra/terraform
          framework: terraform
          output_format: sarif,cli
          output_file_path: ${{ env.REPORTS_DIR }}/checkov-results.sarif
          soft_fail: true # Don't fail the job, let gate evaluator decide

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@c36620d31ac7c881962c3d9dd939c40ec9434f2b # v3.26.12
        with:
          sarif_file: ${{ env.REPORTS_DIR }}/checkov-results.sarif
          category: checkov

      - name: Upload IaC scan results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: iac-scan-results
          path: ${{ env.REPORTS_DIR }}/checkov-results.sarif
          retention-days: 30

  # ==========================================================================
  # Job 6: Container Scanning (Trivy)
  # ==========================================================================
  container-scan:
    name: üê≥ Container Scanning (Trivy)
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.should_scan == 'true'
    permissions:
      security-events: write
      contents: read
    strategy:
      matrix:
        app: [ 'node-api', 'dotnet-api' ]
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@18f2510ee396bbf400402c7deaa6b7ff5ce77a63 # v0.28.0
        with:
          scan-type: 'fs'
          scan-ref: 'apps/${{ matrix.app }}'
          format: 'sarif'
          output: '${{ env.REPORTS_DIR }}/trivy-${{ matrix.app }}-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          exit-code: '0' # Don't fail, let gate evaluator decide

      - name: Upload Trivy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@c36620d31ac7c881962c3d9dd939c40ec9434f2b # v3.26.12
        with:
          sarif_file: '${{ env.REPORTS_DIR }}/trivy-${{ matrix.app }}-results.sarif'
          category: 'trivy-${{ matrix.app }}'

      - name: Upload container scan results
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: container-scan-${{ matrix.app }}
          path: '${{ env.REPORTS_DIR }}/trivy-${{ matrix.app }}-results.sarif'
          retention-days: 30

  # ==========================================================================
  # Job 7: Gate Evaluation
  # ==========================================================================
  gate-evaluation:
    name: ‚öñÔ∏è Security Gate Evaluation
    runs-on: ubuntu-latest
    needs: [ secrets-scan, sast-scan, dependency-scan, iac-scan, container-scan ]
    if: always()
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Node.js
        uses: actions/setup-node@0a44ba7841725637a19e28fa30b79a866c81b0a6 # v4.0.4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm install -g typescript ts-node @types/node js-yaml @types/js-yaml glob

      - name: Download all scan results
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: ${{ env.REPORTS_DIR }}/artifacts

      - name: Consolidate results
        run: |
          mkdir -p ${{ env.REPORTS_DIR }}
          find ${{ env.REPORTS_DIR }}/artifacts -type f \( -name "*.sarif" -o -name "*.json" \) -exec cp {} ${{ env.REPORTS_DIR }}/ \;
          ls -la ${{ env.REPORTS_DIR }}/

      - name: Normalize scan results
        run: |
          ts-node scripts/helpers/normalize-results.ts \
            --results-dir=${{ env.REPORTS_DIR }} \
            --output=${{ env.REPORTS_DIR }}/normalized.json

      - name: Post results to API
        if: always()
        env:
          API_URL: ${{ secrets.API_URL || 'http://localhost:3001' }}
          API_KEY: ${{ secrets.API_KEY_CI_CD }}
        run: |
          if [ -n "$API_KEY" ] && [ -n "$API_URL" ]; then
            echo "üì§ Posting scan results to API..."
            curl -X POST "$API_URL/api/v1/scans" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: $API_KEY" \
              -d @- <<EOF
          {
            "metadata": {
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "triggeredBy": "${{ github.actor }}"
            },
            "summary": $(jq '.summary' ${{ env.REPORTS_DIR }}/normalized.json),
            "findings": $(jq '.findings' ${{ env.REPORTS_DIR }}/normalized.json)
          }
          EOF
            echo "‚úÖ Results posted to API"
          else
            echo "‚ö†Ô∏è  API credentials not configured, skipping API upload"
          fi

      - name: Generate security report
        run: |
          ts-node scripts/gates/report-writer.ts \
            --input=${{ env.REPORTS_DIR }}/normalized.json \
            --output=${{ env.REPORTS_DIR }}/security-summary.md

      - name: Evaluate security gates
        id: gate
        run: |
          ts-node scripts/gates/gate-evaluator.ts \
            --config=scripts/gates/thresholds.yml \
            --results-dir=${{ env.REPORTS_DIR }}

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('${{ env.REPORTS_DIR }}/security-summary.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Upload final reports
        if: always()
        uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4.3.6
        with:
          name: security-reports
          path: |
            ${{ env.REPORTS_DIR }}/security-summary.md
            ${{ env.REPORTS_DIR }}/normalized.json
          retention-days: 90

      - name: Job summary
        if: always()
        run: |
          cat ${{ env.REPORTS_DIR }}/security-summary.md >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Job 8: Deploy Dashboard
  # ==========================================================================
  deploy-dashboard:
    name: üìä Deploy Dashboard
    runs-on: ubuntu-latest
    needs: [ gate-evaluation ]
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: write
      pages: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Download security reports
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: security-reports
          path: ${{ env.REPORTS_DIR }}

      - name: Setup Node.js
        uses: actions/setup-node@0a44ba7841725637a19e28fa30b79a866c81b0a6 # v4.0.4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: dashboard/package-lock.json

      - name: Install dashboard dependencies
        working-directory: dashboard
        run: npm ci

      - name: Build dashboard with embedded data
        working-directory: dashboard
        run: |
          mkdir -p public/data
          cp ../${{ env.REPORTS_DIR }}/normalized.json public/data/latest.json
          npm run build
        env:
          VITE_GITHUB_REPO: ${{ github.repository }}
          VITE_PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dashboard/dist
          publish_branch: gh-pages
          destination_dir: pr-${{ github.event.pull_request.number }}
          keep_files: true

      - name: Update PR comment with dashboard link
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('${{ env.REPORTS_DIR }}/security-summary.md', 'utf8');
            const dashboardUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.pull_request.number }}/`;

            const comment = `${summary}

            ---

            ## üìä Interactive Security Dashboard

            **[üöÄ View Interactive Dashboard ‚Üí](${dashboardUrl})**

            Features:
            - üîç Real-time scan results with severity breakdown
            - üìä Visual charts and metrics
            - üîé Searchable findings table
            - ‚úÖ Compliance scorecard
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ==========================================================================
  # Job 9: Final Status
  # ==========================================================================
  security-status:
    name: üìä Security Status
    runs-on: ubuntu-latest
    needs: [ gate-evaluation ]
    if: always()
    steps:
      - name: Check gate status
        run: |
          if [ "${{ needs.gate-evaluation.result }}" == "success" ]; then
            echo "‚úÖ All security gates PASSED"
            exit 0
          else
            echo "‚ùå Security gates FAILED"
            exit 1
          fi
